#!/bin/sh

set -eu


COMMAND_DESCRIPTION="Manage dotfiles' symlinks."
# @getoptions
argparser_definition() {
  type generate_subcommand_parser_definitions >/dev/null || . $COMMANDS_DIR/_parse_args_helpers

	setup   REST help:usage abbr:true -- \
        "$(dotfiles_banner)" '' '' \
		"Usage: $PROGRAM [options...]" '' \
        "$COMMAND_DESCRIPTION" ''
	msg -- 'Options:'
	flag    DRY_RUN -n, --dry-run -- "Show what would be done without actually doing any of it."
	disp    :usage  -h --help
}
[ "$(basename "$0")" = "gengetoptions" ] && return 0 || true
# @end

. "$COMMANDS_DIR/_parse_args"

do_unless_dry_run() {
	if [ "$DRY_RUN" = "1" ]; then
		echo "$@"
	else
		"$@"
	fi
}

create_link () {
  target="$1"
  name="$2"
  if [ -e "$target" ]; then
    if [ "$NO_BACKUPS" = "0" -a -f "$name" -a ! -L "$name" ]; then
      backup="$name-`date +%Y%m%dT%H%M%S`"
      do_unless_dry_run mv "$name" "$backup"
    fi
    do_unless_dry_run mkdir -p "`dirname \"$name\"`"
    do_unless_dry_run ln -fsT "$target" "$name"
  fi
}

{% for link in config_file_symlinks %}
create_link "{{ dotfiles_home }}/{{ link.src }}" "{{ link.dest }}"
{% endfor %}
